<?php

function getnameCheck($filename) {
  $pieces = explode('.',$filename);
  $name= array_shift($pieces);
  $name = str_replace('_','.',$name);
  $ext = implode('.',$pieces);
  #echo "name $name - ext $ext\n";
  return array($name,$ext);
}

function check_ip($prefix,$filename) {
  //echo "prefix: $prefix - fname: $filename<br>\n";
  $ret = true;
  if (!(filter_var($prefix, FILTER_VALIDATE_IP))) {
    $ret = false;
    $msg = "4tt4ck on file ".$filename.": prefix is not a valid ip \n";
  } else {
    $msg = $filename;
  }
  echo "\ncheck_ip returns:\n";
  echo "$ret, $msg\n";
  return array($ret,$msg);
}

$path = '/home/kali/Desktop/Development/writeups/hack-the-box/Networked/exploitation/privesc/exploit';

$files = array();
$files = preg_grep('/^([^.])/', scandir($path));

foreach ($files as $key => $value) {
    $msg='';
  if ($value == 'index.html') {
        continue;
  }
  #echo "-------------\n";

  #print "check: $value\n";
  list ($name,$ext) = getnameCheck($value);
  $check = check_ip($name,$value);

  echo "\nNAME: $name";
  echo "\nVALUE: $value\n";

  if (!($check[0])) {
    echo "\nattack!\n";
    # todo: attach file
    echo "exec(\"nohup /bin/rm -f $path$value > /dev/null 2>&1 &\")";
  }
}

?>
